<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTL RECORDS44 | Studio Manager</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --gold: #ffd700; --dark: #0b0b0b; --card: #151515; --input-bg: #222; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: all 0.2s; }
        body { background: var(--dark); color: #fff; margin: 0; padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        h1 { color: var(--gold); margin: 0; font-size: 24px; letter-spacing: 2px; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-left: 4px solid var(--gold); margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; outline: none; }
        button { background: var(--gold); color: #000; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; }
        button:disabled { background: #444; color: #888; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; float: right; }
        .status-PENDING { background: #ffc107; color: #000; }
        .status-APPROVED { background: #28a745; color: #fff; }
    </style>
</head>

<body>
    <header><h1>ðŸŽµ GTL RECORDS44</h1></header>

    <div class="container">
        <div id="authView">
            <div class="card">
                <h2 id="authTitle" style="color:var(--gold); margin-top:0;">Artist Login</h2>
                <input id="authEmail" type="email" placeholder="Email Address">
                <input id="authPass" type="password" placeholder="Password">
                <button onclick="handleAuth()" id="authBtn">Login</button>
                <p style="color:var(--gold); cursor:pointer; text-align:center; font-size:14px;" onclick="toggleAuthMode()">New here? Create an account</p>
            </div>
        </div>

        <div id="artistDash" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Artist: <span id="userDisp" style="color:var(--gold)"></span></h2>
                <button onclick="logout()" style="width:auto; padding:5px 15px; background:#333; color:#fff;">Logout</button>
            </div>
            <div class="card">
                <h3>Book Session</h3>
                <select id="service">
                    <option>Recording Session (1hr)</option>
                    <option>Recording Session (2hrs)</option>
                    <option>Mixing & Mastering</option>
                </select>
                <input type="date" id="bookDate">
                <input type="time" id="bookTime">
                <textarea id="notes" placeholder="Notes (Project name, BPM...)" rows="2"></textarea>
                <button onclick="submitBooking()" id="submitBtn">Request Booking</button>
            </div>
            <div id="history"></div>
        </div>

        <div id="adminDash" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:var(--gold)">Admin Portal</h2>
                <button onclick="logout()" style="width:auto; padding:5px 15px; background:#333; color:#fff;">Logout</button>
            </div>
            <div id="adminList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KEYS ---
        const firebaseConfig = { apiKey: "AIzaSyD6XKgyi5JrnMS8gChPX_vytYV6nRELLPM", authDomain: "gtlrecords44-30a2b.firebaseapp.com", projectId: "gtlrecords44-30a2b" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const EMAILJS_SERVICE_ID = "service_km8fhqd";
        const WELCOME_TEMPLATE_ID = "template_amlvjzf"; 

        // Initialize EmailJS
        const initEJS = () => { if(window.emailjs) window.emailjs.init("Vt8sYPk16RSvIfEMQ"); else setTimeout(initEJS, 500); };
        initEJS();

        let isRegister = false;

        window.toggleAuthMode = () => {
            isRegister = !isRegister;
            document.getElementById('authTitle').innerText = isRegister ? "Create Account" : "Artist Login";
            document.getElementById('authBtn').innerText = isRegister ? "Register" : "Login";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            if(!email || !pass) return alert("Please fill in all fields.");
            try {
                if(isRegister) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    if(window.emailjs) await window.emailjs.send(EMAILJS_SERVICE_ID, WELCOME_TEMPLATE_ID, { user_email: email });
                    alert("Welcome! Account created.");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) { alert(e.message); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, u => {
            document.getElementById('authView').classList.toggle('hidden', !!u);
            if(u) {
                if(u.email === "gtlrecords44@gmail.com") {
                    document.getElementById('adminDash').classList.remove('hidden');
                    loadAdmin();
                } else {
                    document.getElementById('artistDash').classList.remove('hidden');
                    document.getElementById('userDisp').innerText = u.email.split('@')[0];
                    loadHistory(u.email);
                }
            } else {
                document.getElementById('artistDash').classList.add('hidden');
                document.getElementById('adminDash').classList.add('hidden');
            }
        });

        window.submitBooking = async () => {
            const date = document.getElementById('bookDate').value;
            const time = document.getElementById('bookTime').value;
            if(!date || !time) return alert("Select Date & Time");
            
            try {
                await addDoc(collection(db, "bookings"), {
                    artist: auth.currentUser.email,
                    service: document.getElementById('service').value,
                    date: date,
                    time: time,
                    notes: document.getElementById('notes').value,
                    status: "PENDING",
                    createdAt: serverTimestamp()
                });
                alert("Booking Sent!");
                document.getElementById('notes').value = "";
            } catch (e) { alert("Error: " + e.message); }
        };

        function loadHistory(email) {
            onSnapshot(query(collection(db, "bookings"), where("artist", "==", email), orderBy("createdAt", "desc")), snap => {
                document.getElementById('history').innerHTML = snap.docs.map(d => `
                    <div class="card"><span class="badge status-${d.data().status}">${d.data().status}</span>
                    <b>${d.data().service}</b><br>${d.data().date} @ ${d.data().time}</div>
                `).join("");
            });
        }

        function loadAdmin() {
            onSnapshot(query(collection(db, "bookings"), orderBy("createdAt", "desc")), snap => {
                document.getElementById('adminList').innerHTML = snap.docs.map(d => `
                    <div class="card"><b>${d.data().artist}</b> - ${d.data().service}<br>${d.data().date} @ ${d.data().time}
                    <div style="margin-top:10px;">
                        <button onclick="approve('${d.id}')" style="width:auto; padding:5px 10px;">Approve</button>
                        <button onclick="removeBook('${d.id}')" style="width:auto; padding:5px 10px; background:#444;">Delete</button>
                    </div></div>
                `).join("");
            });
        }

        window.approve = (id) => updateDoc(doc(db, "bookings", id), { status: "APPROVED" });
        window.removeBook = (id) => confirm("Delete?") && deleteDoc(doc(db, "bookings", id));
    </script>
</body>
</html>
