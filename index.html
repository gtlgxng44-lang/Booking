<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTL RECORDS44 | Studio Manager</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --gold: #ffd700; --dark: #0b0b0b; --card: #151515; --input-bg: #222; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: all 0.2s; }
        body { background: var(--dark); color: #fff; margin: 0; padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        h1 { color: var(--gold); margin: 0; font-size: 24px; letter-spacing: 2px; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-left: 4px solid var(--gold); margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; outline: none; }
        button { background: var(--gold); color: #000; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; }
        button:disabled { background: #444; color: #888; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; float: right; }
        .status-PENDING { background: #ffc107; color: #000; }
        .status-APPROVED { background: #28a745; color: #fff; }
        #loading { text-align: center; padding: 40px; color: #888; }
    </style>
</head>

<body>
    <header><h1>ðŸŽµ GTL RECORDS44</h1></header>

    <div class="container">
        <div id="loading">Loading Studio...</div>

        <div id="authView" class="hidden">
            <div class="card">
                <h2 id="authTitle" style="color:var(--gold); margin-top:0;">Artist Login</h2>
                <input id="authEmail" type="email" placeholder="Email Address">
                <input id="authPass" type="password" placeholder="Password">
                <button onclick="handleAuth()" id="authBtn">Login</button>
                <p style="color:var(--gold); cursor:pointer; text-align:center; font-size:14px;" onclick="toggleAuthMode()">New here? Create an account</p>
            </div>
        </div>

        <div id="artistDash" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Artist: <span id="userDisp" style="color:var(--gold)"></span></h2>
                <button onclick="logout()" style="width:auto; padding:5px 15px; background:#333; color:#fff;">Logout</button>
            </div>
            <div class="card">
                <h3>Book Session</h3>
                <select id="service">
                    <option>Recording Session (1hr)</option>
                    <option>Recording Session (2hrs)</option>
                    <option>Mixing & Mastering</option>
                </select>
                <input type="date" id="bookDate">
                <input type="time" id="bookTime">
                <textarea id="notes" placeholder="Notes (Project name, BPM...)" rows="2"></textarea>
                <button onclick="submitBooking()" id="submitBtn">Request Booking</button>
            </div>
            <div id="history"></div>
        </div>

        <div id="adminDash" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:var(--gold)">Admin Portal</h2>
                <button onclick="logout()" style="width:auto; padding:5px 15px; background:#333; color:#fff;">Logout</button>
            </div>
            <div id="adminList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, updateDoc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyD6XKgyi5JrnMS8gChPX_vytYV6nRELLPM", 
            authDomain: "gtlrecords44-30a2b.firebaseapp.com", 
            projectId: "gtlrecords44-30a2b" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // EmailJS Config
        const EMAILJS_KEY = "Vt8sYPk16RSvIfEMQ";
        const EMAILJS_SERVICE_ID = "service_km8fhqd";
        const WELCOME_TEMPLATE_ID = "template_amlvjzf"; 

        // Init EmailJS safely
        if(window.emailjs) window.emailjs.init(EMAILJS_KEY);

        let isRegister = false;

        // --- AUTH FUNCTIONS ---
        window.toggleAuthMode = () => {
            isRegister = !isRegister;
            document.getElementById('authTitle').innerText = isRegister ? "Create Account" : "Artist Login";
            document.getElementById('authBtn').innerText = isRegister ? "Register" : "Login";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            if(!email || !pass) return alert("Please fill in all fields.");
            
            try {
                if(isRegister) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    // Try to send email, but don't block login if it fails
                    if(window.emailjs) {
                        window.emailjs.send(EMAILJS_SERVICE_ID, WELCOME_TEMPLATE_ID, { user_email: email })
                            .catch(err => console.log("Email failed", err));
                    }
                    alert("Welcome! Account created.");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) { 
                alert("Login Error: " + e.message); 
            }
        };

        window.logout = () => signOut(auth);

        // --- STATE MANAGEMENT ---
        onAuthStateChanged(auth, u => {
            document.getElementById('loading').classList.add('hidden'); // Stop loading
            
            if(u) {
                document.getElementById('authView').classList.add('hidden');
                
                if(u.email === "gtlrecords44@gmail.com") {
                    document.getElementById('adminDash').classList.remove('hidden');
                    loadAdmin();
                } else {
                    document.getElementById('artistDash').classList.remove('hidden');
                    document.getElementById('userDisp').innerText = u.email.split('@')[0];
                    loadHistory(u.email);
                }
            } else {
                document.getElementById('authView').classList.remove('hidden');
                document.getElementById('artistDash').classList.add('hidden');
                document.getElementById('adminDash').classList.add('hidden');
            }
        });

        // --- BOOKING LOGIC (FIXED) ---
        window.submitBooking = async () => {
            // 1. Get Elements
            const dateEl = document.getElementById('bookDate');
            const timeEl = document.getElementById('bookTime');
            const notesEl = document.getElementById('notes');
            const serviceEl = document.getElementById('service');
            const btn = document.getElementById('submitBtn');

            // 2. Validate Inputs
            if(!dateEl.value || !timeEl.value) return alert("Please Select Date & Time");
            if(!auth.currentUser) return alert("You must be logged in.");

            btn.disabled = true; // Prevent double clicking
            btn.innerText = "Processing...";

            try {
                // 3. Optional: Check for double booking
                const q = query(collection(db, "bookings"), where("date", "==", dateEl.value), where("time", "==", timeEl.value));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    throw new Error("This time slot is already booked. Please choose another.");
                }

                // 4. Send Data
                await addDoc(collection(db, "bookings"), {
                    artist: auth.currentUser.email,
                    service: serviceEl.value,
                    date: dateEl.value,
                    time: timeEl.value,
                    notes: notesEl ? notesEl.value : "",
                    status: "PENDING",
                    createdAt: serverTimestamp()
                });

                alert("Booking Request Sent Successfully!");
                if(notesEl) notesEl.value = ""; // Clear notes

            } catch (e) {
                console.error("Booking Error:", e);
                // Display the ACTUAL error message
                alert("Error: " + (e.message || "Unknown error occurred"));
            } finally {
                btn.disabled = false;
                btn.innerText = "Request Booking";
            }
        };

        // --- DATA LOADERS ---
        function loadHistory(email) {
            onSnapshot(query(collection(db, "bookings"), where("artist", "==", email), orderBy("createdAt", "desc")), 
            (snap) => {
                const historyDiv = document.getElementById('history');
                if(snap.empty) {
                    historyDiv.innerHTML = "<p style='color:#666; text-align:center;'>No bookings yet.</p>";
                    return;
                }
                historyDiv.innerHTML = snap.docs.map(d => `
                    <div class="card">
                        <span class="badge status-${d.data().status}">${d.data().status}</span>
                        <b style="color:var(--gold)">${d.data().service}</b><br>
                        ${d.data().date} @ ${d.data().time}
                    </div>
                `).join("");
            }, 
            (error) => {
                console.log("History Error:", error);
                // Don't alert here to avoid spamming the user, just log it
            });
        }

        function loadAdmin() {
            onSnapshot(query(collection(db, "bookings"), orderBy("createdAt", "desc")), snap => {
                document.getElementById('adminList').innerHTML = snap.docs.map(d => `
                    <div class="card">
                        <b style="color:var(--gold)">${d.data().artist}</b><br>
                        ${d.data().service}<br>
                        ${d.data().date} @ ${d.data().time}<br>
                        <i style="font-size:12px; color:#aaa;">${d.data().notes || ""}</i>
                        <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                            Status: <span class="${d.data().status == 'APPROVED' ? 'status-APPROVED' : 'status-PENDING'} badge" style="float:none;">${d.data().status}</span>
                            <div style="float:right;">
                                ${d.data().status !== 'APPROVED' ? `<button onclick="approve('${d.id}')" style="width:auto; padding:5px 10px; font-size:12px;">Approve</button>` : ''}
                                <button onclick="removeBook('${d.id}')" style="width:auto; padding:5px 10px; background:#d9534f; color:#fff; font-size:12px;">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join("");
            });
        }

        // --- ADMIN ACTIONS ---
        window.approve = (id) => updateDoc(doc(db, "bookings", id), { status: "APPROVED" }).catch(e => alert(e.message));
        window.removeBook = (id) => confirm("Permanently delete this booking?") && deleteDoc(doc(db, "bookings", id)).catch(e => alert(e.message));
    </script>
</body>
</html>
