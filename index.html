<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTL RECORDS44 | Artist Portal</title>
    <style>
        :root { --gold: #ffd700; --dark: #0b0b0b; --card: #151515; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--dark); color: #fff; margin: 0; padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        h1 { color: var(--gold); margin: 0; font-size: 24px; letter-spacing: 2px; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-left: 4px solid var(--gold); margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; }
        button { background: var(--gold); color: #000; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #e6c200; }
        .hidden { display: none !important; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; float: right; background: #444; }
        .contact-row { display: flex; gap: 10px; margin-top: 15px; }
        .contact-btn { flex: 1; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 13px; text-align: center; }
        .whatsapp { background: #25D366; color: white; }
        .call { background: var(--gold); color: black; }
        .logout { background: #333; color: #fff; max-width: 100px; margin: 20px auto; display: block; font-size: 10px; }
        audio { width: 100%; margin-top: 10px; height: 35px; }
        progress { width: 100%; height: 10px; accent-color: var(--gold); }
    </style>
</head>
<body>

<header><h1>üéµ GTL RECORDS44</h1></header>

<div class="container">
    
    <!-- 1. AUTH VIEW -->
    <div id="authView">
        <div class="card">
            <h2 id="authTitle" style="color:var(--gold); margin-top:0;">Login</h2>
            <input id="authEmail" type="email" placeholder="Email Address">
            <input id="authPass" type="password" placeholder="Password">
            <button onclick="handleAuth()" id="authBtn">Login</button>
            <p style="color:var(--gold); cursor:pointer; text-align:center; font-size:13px; margin-top:15px;" onclick="toggleAuthMode()">New Artist? Create Profile</p>
        </div>
        <div class="card" style="text-align:center;">
            <p style="margin:0; font-size:14px; color:#aaa;">For assistance:</p>
            <div class="contact-row">
                <a href="https://wa.me/254105076414" class="contact-btn whatsapp">WhatsApp</a>
                <a href="tel:+254105076414" class="contact-btn call">Call</a>
            </div>
        </div>
        <p style="text-align:center; font-size:10px; color:#333; cursor:pointer;" onclick="showAdminLogin()">Admin Dashboard</p>
    </div>

    <!-- 2. PROFILE SETUP (For New Users) -->
    <div id="profileSetup" class="hidden">
        <div class="card">
            <h2 style="color:var(--gold); margin-top:0;">Complete Your Profile</h2>
            <p>Welcome! Please enter your official Stage Name to continue.</p>
            <input id="stageNameInput" placeholder="Stage Name (e.g. Young King)">
            <button onclick="saveProfile()">Save & Continue</button>
        </div>
    </div>

    <!-- 3. ARTIST DASHBOARD -->
    <div id="artistDash" class="hidden">
        <h2 style="margin:0;">üé§ <span id="userDisp" style="color:var(--gold)"></span></h2>
        <div class="card">
            <h3>New Submission</h3>
            <label>What do you need?</label>
            <select id="service">
                <option>Recording Session</option>
                <option>Mixing & Mastering</option>
                <option>Full Production</option>
                <option>Beat Purchase</option>
            </select>
            
            <label style="display:block; margin-top:15px; font-size:13px; color:var(--gold);">Upload Sample Audio (Optional)</label>
            <input type="file" id="audioFile" accept="audio/*">
            <progress id="uploadProgress" value="0" max="100" class="hidden"></progress>
            
            <textarea id="notes" placeholder="Tell us about the project (BPM, Mood, etc.)"></textarea>
            <button onclick="submitBooking()" id="submitBtn">Submit to Studio</button>
        </div>
        <h3 style="margin-top:30px;">Submission History</h3>
        <div id="history"></div>
        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <!-- 4. ADMIN DASHBOARD -->
    <div id="adminDash" class="hidden">
        <h2 style="color:var(--gold);">üîê Admin Control</h2>
        <div id="adminList"></div>
        <button class="logout" onclick="location.reload()">Exit Admin</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6XKgyi5JrnMS8gChPX_vytYV6nRELLPM",
      authDomain: "gtlrecords44-30a2b.firebaseapp.com",
      projectId: "gtlrecords44-30a2b",
      storageBucket: "gtlrecords44-30a2b.firebasestorage.app",
      messagingSenderId: "759451881734",
      appId: "1:759451881734:web:39ca165d3643485e9c0e87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let isRegister = false;
    let myStageName = "";

    // UI TOGGLES
    window.toggleAuthMode = () => {
        isRegister = !isRegister;
        document.getElementById('authTitle').innerText = isRegister ? "Create Artist Account" : "Artist Login";
        document.getElementById('authBtn').innerText = isRegister ? "Sign Up" : "Login";
    };

    window.handleAuth = async () => {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        try {
            if(isRegister) await createUserWithEmailAndPassword(auth, email, pass);
            else await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) { alert(e.message); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists()) {
                document.getElementById('authView').classList.add('hidden');
                document.getElementById('profileSetup').classList.remove('hidden');
            } else {
                myStageName = userDoc.data().stageName;
                document.getElementById('userDisp').innerText = myStageName;
                document.getElementById('authView').classList.add('hidden');
                document.getElementById('profileSetup').classList.add('hidden');
                document.getElementById('artistDash').classList.remove('hidden');
                loadHistory();
            }
        } else {
            document.getElementById('authView').classList.remove('hidden');
            document.getElementById('artistDash').classList.add('hidden');
        }
    });

    window.saveProfile = async () => {
        const name = document.getElementById('stageNameInput').value.trim();
        if(!name) return alert("Stage Name required");
        await setDoc(doc(db, "users", auth.currentUser.uid), { stageName: name });
        location.reload();
    };

    // SUBMIT WITH AUDIO
    window.submitBooking = async () => {
        const file = document.getElementById('audioFile').files[0];
        const service = document.getElementById('service').value;
        const notes = document.getElementById('notes').value;
        const btn = document.getElementById('submitBtn');
        let audioUrl = "";

        btn.disabled = true;

        if (file) {
            const storageRef = ref(storage, 'samples/' + Date.now() + "_" + file.name);
            const uploadTask = uploadBytesResumable(storageRef, file);
            document.getElementById('uploadProgress').classList.remove('hidden');

            uploadTask.on('state_changed', 
                (snap) => { document.getElementById('uploadProgress').value = (snap.bytesTransferred / snap.totalBytes) * 100; },
                (err) => alert("Upload failed"),
                async () => {
                    audioUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    finalizeBooking(service, notes, audioUrl);
                }
            );
        } else {
            finalizeBooking(service, notes, "");
        }
    };

    async function finalizeBooking(service, notes, url) {
        await addDoc(collection(db, "bookings"), {
            stageName: myStageName,
            artistEmail: auth.currentUser.email,
            service: service,
            notes: notes,
            audio: url,
            status: "PENDING",
            createdAt: new Date().toISOString()
        });
        alert("Submitted Successfully!");
        location.reload();
    }

    function loadHistory() {
        onSnapshot(query(collection(db, "bookings"), orderBy("createdAt", "desc")), snap => {
            const data = snap.docs.map(d => d.data()).filter(b => b.stageName === myStageName);
            document.getElementById('history').innerHTML = data.map(b => `
                <div class="card">
                    <span class="status">${b.status}</span>
                    <b>${b.service}</b><br>
                    <small>${b.createdAt.split('T')[0]}</small>
                </div>
            `).join('');
        });
    }

    // ADMIN
    window.showAdminLogin = () => {
        const p = prompt("Admin Code:");
        if(p === "gtlrecords44@26") {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('adminDash').classList.remove('hidden');
            loadAdmin();
        }
    };

    function loadAdmin() {
        onSnapshot(query(collection(db, "bookings"), orderBy("createdAt", "desc")), snap => {
            document.getElementById('adminList').innerHTML = snap.docs.map(d => `
                <div class="card">
                    <b>üé§ ${d.data().stageName}</b> (${d.data().service})<br>
                    Notes: ${d.data().notes || 'None'}<br>
                    ${d.data().audio ? `<audio controls src="${d.data().audio}"></audio>` : '<p>No Audio Sample</p>'}
                </div>
            `).join('');
        });
    }

    window.logout = () => signOut(auth);
</script>
</body>
</html>